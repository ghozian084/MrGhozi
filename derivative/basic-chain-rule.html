<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculus: The Chain Rule</title>
    
    <!-- MathJax for LaTeX -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --primary: #e84393;
            --secondary: #fd79a8;
            --inside: #00b894;
            --outside: #0984e3;
            --bg: #f5f6fa;
            --card: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: #2d3436;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .header {
            background: #2d3436;
            color: white;
            width: 100%;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .container {
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            padding-bottom: 50px;
        }

        .section {
            background: var(--card);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border-left: 6px solid var(--primary);
        }

        h2 { color: var(--primary); margin-top: 0; }
        p { line-height: 1.6; font-size: 1.1rem; }

        /* --- ANIMATION STYLES --- */
        .anim-box {
            background: #dfe6e9;
            height: 200px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            position: relative;
            overflow: hidden;
            font-family: 'Times New Roman', serif;
        }

        .blob { 
            background: var(--inside); 
            color: white; 
            padding: 5px 15px; 
            border-radius: 50px; 
            display: inline-block;
            z-index: 2;
        }
        .blob-ghost {
            background: var(--inside);
            opacity: 0.5;
            padding: 5px 15px;
            border-radius: 50px;
            display: none;
        }
        
        /* --- DRAG & DROP STYLES --- */
        .dnd-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .dnd-zone {
            background: #f1f2f6;
            border: 2px dashed #b2bec3;
            border-radius: 10px;
            padding: 20px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .zone-label { font-weight: bold; color: #636e72; margin-bottom: 10px; }
        
        .token-pool {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .token {
            background: var(--outside);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: grab;
            font-weight: bold;
            font-size: 1.1rem;
            user-select: none;
        }
        .token:active { cursor: grabbing; }

        /* --- PRACTICE INPUTS --- */
        .step-input-group {
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .math-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            font-size: 1.3rem;
            gap: 5px;
        }

        .math-input {
            padding: 5px;
            border: 2px solid #ccc;
            border-radius: 5px;
            width: 60px;
            text-align: center;
            font-size: 1.1rem;
        }
        .math-input.long { width: 120px; }
        .math-input.superscript { width: 50px; font-size: 0.9rem; margin-bottom: 10px; }
        
        .math-input:focus { border-color: var(--primary); outline: none; }
        .correct { background-color: #55efc4; border-color: #00b894; color: #fff; }
        .wrong { background-color: #ff7675; border-color: #d63031; color: #fff; }

        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 25px;
            border-radius: 5px; font-size: 1rem; cursor: pointer; transition: 0.2s;
        }
        .btn:hover { background: var(--secondary); transform: translateY(-2px); }
        .btn-reset { background: #636e72; }

        .feedback-msg { font-weight: bold; margin-top: 5px; min-height: 24px; font-size: 1rem; }
        
        /* New Styles for Final Answer Box */
        #final-answer-container {
            margin-top: 25px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2rem;
            display: none; /* Hidden by default */
        }
        .success-box { background: #dff9fb; border: 2px solid #00b894; color: #009432; }
        .info-box { background: #fff3cd; border: 2px solid #ffeaa7; color: #856404; }

        .text-out { color: var(--outside); font-weight: bold; }
        .text-in { color: var(--inside); font-weight: bold; }

    </style>
</head>
<body>

    <div class="header">
        <h1>Chain Rule Mastery</h1>
        <p>For algebraic functions: $y = (g(x))^n$</p>
    </div>

    <div class="container">

        <!-- SECTION 1: ANIMATION -->
        <div class="section">
            <h2>1. Visualize the Concept</h2>
            <p>The Chain Rule says: Differentiate the <span class="text-out">Outside</span> (keep inside the same), then multiply by the derivative of the <span class="text-in">Inside</span>.</p>
            
            <div class="anim-box" id="anim-stage">
                <!-- Elements injected by JS -->
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" onclick="playChainAnim()">â–¶ Play Chain Rule</button>
                <button class="btn btn-reset" onclick="resetChainAnim()">Reset</button>
            </div>
        </div>

        <!-- SECTION 2: DRAG & DROP DECOMPOSITION -->
        <div class="section">
            <h2>2. Decompose: Inner & Outer</h2>
            <p>To solve $y = (3x^2 + 5)^4$, drag the correct terms to their boxes.</p>

            <div class="token-pool" id="token-pool">
                <!-- Tokens -->
                <div class="token" draggable="true" data-val="u" ondragstart="drag(event)">3x^2 + 5</div>
                <div class="token" draggable="true" data-val="du" ondragstart="drag(event)">6x</div>
                <div class="token" draggable="true" data-val="y" ondragstart="drag(event)">u^4</div>
                <div class="token" draggable="true" data-val="dy" ondragstart="drag(event)">4u^3</div>
                <!-- Distractors -->
                <div class="token" draggable="true" data-val="fake1" ondragstart="drag(event)">4(3x^2+5)</div>
                <div class="token" draggable="true" data-val="fake2" ondragstart="drag(event)">3x^2</div>
            </div>

            <div class="dnd-container">
                <div class="dnd-zone" id="zone-u" ondrop="drop(event, 'u')" ondragover="allowDrop(event)">
                    <span class="zone-label">1. Inner Function ($u$)</span>
                </div>
                <div class="dnd-zone" id="zone-y" ondrop="drop(event, 'y')" ondragover="allowDrop(event)">
                    <span class="zone-label">2. Outer Function ($y=u^n$)</span>
                </div>
                <div class="dnd-zone" id="zone-du" ondrop="drop(event, 'du')" ondragover="allowDrop(event)">
                    <span class="zone-label">3. Derivative of Inner ($u'$)</span>
                </div>
                <div class="dnd-zone" id="zone-dy" ondrop="drop(event, 'dy')" ondragover="allowDrop(event)">
                    <span class="zone-label">4. Derivative of Outer ($f'(u)$)</span>
                </div>
            </div>
            <div id="dnd-feedback" class="feedback-msg" style="text-align:center; margin-top:15px; color: #2d3436;"></div>
        </div>

        <!-- SECTION 3: STEP-BY-STEP EXERCISE -->
        <div class="section">
            <h2>3. Step-by-Step Practice</h2>
            <p>Solve the derivative for the random function below.</p>
            
            <div style="text-align:center; margin-bottom: 20px; font-size: 1.5rem; background:#fff; padding:15px; border-radius:10px; border:2px solid #eee;">
                <span id="prob-display">$$ f(x) = (2x + 1)^3 $$</span>
            </div>

            <!-- Step 1 -->
            <div class="step-input-group">
                <strong>Step 1: Differentiate the Outside</strong> (Apply Power Rule, keep inside same).
                <br><br>
                <div class="math-row">
                    $f'(outer) = $ 
                    <input type="number" id="inp-out-coeff" class="math-input" placeholder="n">
                    $\times ( \text{Inside} )$
                    <!-- Superscript Input -->
                    <sup>
                        <input type="number" id="inp-out-pow" class="math-input superscript" placeholder="n-1">
                    </sup>
                </div>
                <div id="fb-step1" class="feedback-msg"></div>
            </div>

            <!-- Step 2 -->
            <div class="step-input-group">
                <strong>Step 2: Differentiate the Inside</strong>.
                <br><br>
                <div class="math-row">
                    $\frac{d}{dx}(\text{Inside}) = $ 
                    <input type="text" id="inp-in-deriv" class="math-input long" placeholder="e.g. 3 or 4x">
                </div>
                <div id="fb-step2" class="feedback-msg"></div>
            </div>

            <!-- Step 3 -->
            <div class="step-input-group">
                <strong>Step 3: Final Answer</strong> (Multiply Step 1 coeff by Step 2).
                <br><br>
                <div class="math-row">
                    $f'(x) = $ 
                    <input type="text" id="inp-final-coeff" class="math-input long" placeholder="Coeff"> 
                    $( \text{Inside} )^{\text{power}}$
                </div>
                <div id="fb-step3" class="feedback-msg"></div>
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn" onclick="checkPractice()">Check Answers</button>
                <button class="btn btn-reset" onclick="genProblem()">New Problem</button>
            </div>
            
            <!-- FINAL ANSWER DISPLAY CONTAINER -->
            <div id="final-answer-container"></div>
        </div>

    </div>

<script>
    /* --- 1. ANIMATION LOGIC --- */
    const stage = document.getElementById('anim-stage');

    function resetChainAnim() {
        stage.innerHTML = `
            <div id="anim-wrapper" style="position:relative; transition:1s;">
                <span id="anim-bracket-l">(</span>
                <div id="anim-inside" class="blob">3x + 1</div>
                <span id="anim-bracket-r">)</span>
                <sup id="anim-pow" style="color:var(--outside); font-weight:bold;">5</sup>
            </div>
            <div id="anim-deriv-in" class="blob-ghost" style="position:absolute; right:-100px;">3</div>
        `;
    }

    function playChainAnim() {
        resetChainAnim();
        const wrapper = document.getElementById('anim-wrapper');
        const pow = document.getElementById('anim-pow');
        const inside = document.getElementById('anim-inside');
        
        // 1. Clone Power to move down
        const flyingPow = pow.cloneNode(true);
        flyingPow.style.position = 'absolute';
        flyingPow.style.left = '160px'; 
        flyingPow.style.top = '-20px';
        wrapper.appendChild(flyingPow);

        // Animation Step 1: Power Rule (Move power to front)
        setTimeout(() => {
            flyingPow.style.transition = "all 0.8s ease";
            flyingPow.style.left = "-20px"; 
            flyingPow.style.top = "10px";
            flyingPow.style.fontSize = "1em";
        }, 100);

        // Animation Step 2: Reduce Power
        setTimeout(() => {
            pow.innerHTML = "4";
        }, 1000);

        // Animation Step 3: Reveal "Times Derivative of Inside"
        setTimeout(() => {
            const insideClone = inside.cloneNode(true);
            insideClone.id = "clone-in";
            insideClone.style.position = "absolute";
            insideClone.style.left = "30px";
            insideClone.style.zIndex = "1";
            wrapper.appendChild(insideClone);

            // Slide it out to the right
            setTimeout(() => {
                insideClone.style.transition = "all 1s ease";
                insideClone.style.transform = "translateX(180px)";
                
                // Add multiplication dot
                const dot = document.createElement("span");
                dot.innerHTML = " &middot; ";
                dot.style.position = "absolute";
                dot.style.right = "-20px";
                wrapper.appendChild(dot);
            }, 50);

        }, 1800);

        // Animation Step 4: Differentiate the Clone
        setTimeout(() => {
            const clone = document.getElementById('clone-in');
            clone.style.backgroundColor = "#ffeaa7";
            clone.style.color = "#000";
            clone.style.transform = "translateX(180px) scale(1.1)";
            
            setTimeout(() => {
                clone.innerText = "3"; // Derivative of 3x+1
                clone.style.backgroundColor = "var(--inside)";
                clone.style.color = "white";
                clone.style.transform = "translateX(180px) scale(1)";
            }, 600);
        }, 3000);
    }

    /* --- 2. DRAG & DROP LOGIC --- */
    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { ev.dataTransfer.setData("text", ev.target.dataset.val); }
    
    function drop(ev, correctId) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        
        if(data === correctId) {
            ev.target.innerHTML = "";
            const draggedEl = document.querySelector(`.token[data-val="${data}"]`);
            const clone = draggedEl.cloneNode(true);
            clone.draggable = false;
            clone.style.margin = "0";
            ev.target.appendChild(clone);
            ev.target.style.borderColor = "var(--inside)";
            ev.target.style.background = "#dff9fb";
            checkDnDComplete();
        } else {
            ev.target.style.borderColor = "var(--primary)";
            setTimeout(() => ev.target.style.borderColor = "#b2bec3", 500);
        }
    }

    function checkDnDComplete() {
        const zones = ['zone-u', 'zone-y', 'zone-du', 'zone-dy'];
        const allFilled = zones.every(id => document.getElementById(id).children.length > 0);
        if(allFilled) {
            document.getElementById('dnd-feedback').innerHTML = "<span style='color:green; font-size:1.2rem;'>Correct! You successfully decomposed the function.</span>";
        }
    }

    /* --- 3. EXERCISE LOGIC --- */
    let currentProb = {};

    function genProblem() {
        // Types: 1: (Ax + B)^n   2: (Ax^2 + B)^n
        const type = Math.random() > 0.5 ? 1 : 2;
        const A = Math.floor(Math.random() * 5) + 2;
        const B = Math.floor(Math.random() * 9) + 1;
        const n = Math.floor(Math.random() * 4) + 3; // power 3 to 6

        let latex = "";
        
        if (type === 1) {
            latex = `$$ f(x) = (${A}x + ${B})^${n} $$`;
            currentProb = {
                type: 1, A: A, B: B, n: n,
                outCoeff: n,
                outPow: n - 1,
                inDeriv: A,
                finalCoeff: n * A
            };
        } else {
            latex = `$$ f(x) = (${A}x^2 + ${B})^${n} $$`;
            currentProb = {
                type: 2, A: A, B: B, n: n,
                outCoeff: n,
                outPow: n - 1,
                inDerivVal: 2 * A, // Coeff of x
                inDerivStr: `${2*A}x`,
                finalCoeffVal: n * 2 * A,
                finalCoeffStr: `${n*2*A}x`
            };
        }

        document.getElementById('prob-display').innerHTML = latex;
        MathJax.typesetPromise();

        // Clear Inputs
        document.querySelectorAll('.step-input-group input').forEach(i => {
            i.value = "";
            i.classList.remove('correct', 'wrong');
        });
        document.querySelectorAll('.step-input-group .feedback-msg').forEach(d => d.innerText = "");
        
        // Hide and clear Final Answer Display
        const finalBox = document.getElementById('final-answer-container');
        finalBox.style.display = 'none';
        finalBox.className = '';
        finalBox.innerHTML = '';
    }

    function checkPractice() {
        let allCorrect = true;

        // --- STEP 1 CHECK ---
        const uOutC = parseInt(document.getElementById('inp-out-coeff').value);
        const uOutP = parseInt(document.getElementById('inp-out-pow').value);
        
        if(uOutC === currentProb.outCoeff && uOutP === currentProb.outPow) {
            document.getElementById('fb-step1').innerHTML = "<span style='color:green'>Correct!</span>";
            document.getElementById('inp-out-coeff').classList.add('correct');
            document.getElementById('inp-out-pow').classList.add('correct');
        } else {
            document.getElementById('fb-step1').innerHTML = "<span style='color:red'>Remember: Bring power down, subtract 1.</span>";
            document.getElementById('inp-out-coeff').classList.add('wrong');
            document.getElementById('inp-out-pow').classList.add('wrong');
            allCorrect = false;
        }

        // --- STEP 2 CHECK ---
        const uInDeriv = document.getElementById('inp-in-deriv').value.replace(/\s/g, '');
        let inCorrect = false;
        if(currentProb.type === 1) {
            if(parseInt(uInDeriv) === currentProb.inDeriv) inCorrect = true;
        } else {
            if(uInDeriv === currentProb.inDerivStr) inCorrect = true;
        }

        if(inCorrect) {
            document.getElementById('fb-step2').innerHTML = "<span style='color:green'>Correct!</span>";
            document.getElementById('inp-in-deriv').classList.add('correct');
        } else {
            document.getElementById('fb-step2').innerHTML = "<span style='color:red'>Check derivative of inside.</span>";
            document.getElementById('inp-in-deriv').classList.add('wrong');
            allCorrect = false;
        }

        // --- STEP 3 CHECK ---
        const uFinal = document.getElementById('inp-final-coeff').value.replace(/\s/g, '');
        let finalCorrect = false;
        
        if(currentProb.type === 1) {
            if(parseInt(uFinal) === currentProb.finalCoeff) finalCorrect = true;
        } else {
            if(uFinal === currentProb.finalCoeffStr) finalCorrect = true;
        }

        if(finalCorrect) {
            document.getElementById('fb-step3').innerHTML = "<span style='color:green'>Excellent!</span>";
            document.getElementById('inp-final-coeff').classList.add('correct');
        } else {
            document.getElementById('fb-step3').innerHTML = "<span style='color:red'>Multiply Step 1 coeff by Step 2.</span>";
            document.getElementById('inp-final-coeff').classList.add('wrong');
            allCorrect = false;
        }

        // --- SHOW FULL FINAL ANSWER (LATEX) ---
        let finalLatexStr = "";
        
        if (currentProb.type === 1) {
            // Linear Inner: Coeff(Ax+B)^n
            finalLatexStr = `${currentProb.finalCoeff}(${currentProb.A}x + ${currentProb.B})^{${currentProb.outPow}}`;
        } else {
            // Quadratic Inner: Coeffx(Ax^2+B)^n
            finalLatexStr = `${currentProb.finalCoeffStr}(${currentProb.A}x^2 + ${currentProb.B})^{${currentProb.outPow}}`;
        }

        const finalBox = document.getElementById('final-answer-container');
        finalBox.style.display = 'block';

        if(allCorrect) {
            finalBox.className = 'success-box';
            finalBox.innerHTML = `<strong>Perfect!</strong> The final answer is: $$ f'(x) = ${finalLatexStr} $$`;
        } else {
            finalBox.className = 'info-box';
            finalBox.innerHTML = `<strong>Keep Trying!</strong> The correct answer is: $$ f'(x) = ${finalLatexStr} $$`;
        }
        
        // Render the new LaTeX
        MathJax.typesetPromise();
    }

    // Initialize
    resetChainAnim();
    genProblem();

</script>
</body>
</html>
